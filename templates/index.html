<!DOCTYPE html>
<html>
<head>
    <title>loop: track all moves in a single timeline</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --bg-color: #f8f8f8;
            --text-color: #333;
            --accent-color: #dad3c8;
            --secondary-color: #c5bcb1;
            --border-color: #e5e7eb;
            --card-bg: #ffffff;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-color: #4a4a4a;
            --secondary-color: #333333;
            --border-color: #2c2c2c;
            --card-bg: #1e1e1e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: "Proxima Nova", Tahoma, -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1, h2, h3, h4, h5, h6, p, a, span, div, button {
            text-transform: lowercase;
        }
        
        a {
            color: var(--accent-color);
            text-decoration: none;
        }
        
        a:hover {
            text-decoration: underline;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }
        
        nav {
            display: flex;
            gap: 20px;
        }
        
        nav a {
            padding: 5px 10px;
            border-radius: 4px;
            color: var(--text-color);
            background-color: transparent;
            transition: color 0.2s ease;
            box-shadow: none;
            text-decoration: none;
        }
        
        nav a.active {
            background-color: transparent;
            color: var(--text-color);
            font-weight: 500;
            position: relative;
        }
        
        nav a.active:after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: var(--text-color);
        }
        
        nav a:hover {
            background-color: transparent;
            text-decoration: underline;
        }
        
        .theme-toggle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 18px;
            margin-left: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000000;
        }
        
        .main-container {
            display: flex;
            gap: 30px;
        }
        
        .brief-list {
            flex: 1;
            max-width: 800px;
        }
        
        .brief-card {
            background-color: var(--card-bg);
            padding: 24px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .home-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .brief-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-color);
            flex: 1;
        }
        
        .card-right-elements {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .detail-link {
            display: flex;
            align-items: center;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 14px;
            transition: opacity 0.2s ease;
        }
        
        .detail-link .arrow {
            margin-left: 5px;
            font-size: 16px;
        }
        
        .brief-card:hover .detail-link {
            opacity: 0.9;
        }
        
        [data-theme="dark"] .brief-card {
            box-shadow: none;
        }
        
        .brief-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        [data-theme="dark"] .brief-card:hover {
            box-shadow: none;
        }
        
        /* Separate styles for detail page */
        .detail-page .brief-meta {
            display: flex;
            justify-content: flex-end;
            font-size: 14px;
            color: #666;
            margin-bottom: 0;
            position: absolute;
            top: 24px;
            right: 24px;
        }
        
        .brief-meta {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
        }
        
        .brief-summary-container {
            display: flex;
            flex-direction: column;
            margin-bottom: 16px;
        }
        
        .summary-date {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .refresh-info {
            display: flex;
            align-items: center;
            background-color: transparent;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            white-space: nowrap;
        }
        
        [data-theme="dark"] .refresh-info {
            background-color: transparent;
            color: #ffffff;
        }
        
        .reload-timer {
            font-weight: bold;
            color: var(--accent-color);
            margin-left: 4px;
            opacity: 0.9;
        }
        
        [data-theme="dark"] .reload-timer {
            color: #ffffff;
            opacity: 0.9;
        }
        
        .cta-button {
            background-color: var(--accent-color);
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .cta-button {
            box-shadow: none;
        }
        
        .cta-button:hover {
            background-color: var(--secondary-color);
        }
        
        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .search-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .option-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: white;
            font-size: 14px;
        }
        
        .timeline-container {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .timeline-day {
            font-size: 18px;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .day-summary {
            background-color: var(--accent-color);
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            line-height: 1.7;
            font-style: italic;
            color: var(--text-color);
        }
        
        /* Flickering red dot */
        .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ff3b30;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
            position: relative;
            top: -1px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.4;
            }
            100% {
                opacity: 1;
            }
        }
        
        .latest-update {
            font-style: italic;
            color: #888;
            font-weight: 300;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .timeline-item {
            border-left: 3px solid var(--accent-color);
            padding-left: 20px;
            margin-bottom: 25px;
            padding-bottom: 15px;
        }
        
        .topic-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            position: relative;
        }
        
        .expand-icon {
            display: inline-block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 5px 0 5px 8px;
            border-color: transparent transparent transparent var(--text-color);
            margin-right: 10px;
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0.6;
            transform-origin: center;
        }
        
        .topic-header.expanded .expand-icon {
            transform: rotate(90deg);
            opacity: 0.9;
        }
        
        .topic-title {
            font-size: 17px;
            font-weight: 600;
            margin-right: 10px;
            color: var(--text-color);
            opacity: 0.85;
        }
        
        .topic-count {
            background-color: var(--secondary-color);
            color: #000000;
            border-radius: 12px;
            padding: 2px 10px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .topic-time {
            color: #666;
            font-size: 14px;
            margin-left: auto;
        }
        
        .topic-content {
            display: none;
            margin-left: 20px;
        }
        
        .article-item {
            border-left: 2px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            border-radius: 4px;
        }
        
        .timeline-source {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .timeline-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .timeline-desc {
            margin-bottom: 15px;
            color: var(--text-color);
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .timeline-link {
            font-size: 14px;
            color: var(--accent-color);
            word-break: break-all;
        }
        
        .error {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .fab-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        [data-theme="dark"] .fab-button {
            box-shadow: none;
            color: #ffffff;
        }
        
        .fab-button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.25);
        }
        
        [data-theme="dark"] .fab-button:hover {
            box-shadow: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        [data-theme="dark"] .modal-content {
            box-shadow: none;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-button {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        
        .cancel-button {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        
        .submit-button {
            background-color: var(--accent-color);
            color: #000000;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .brief-card {
                padding: 20px;
            }
        }
        
        /* Dark mode overrides */
        [data-theme="dark"] .logo,
        [data-theme="dark"] h2,
        [data-theme="dark"] .brief-title,
        [data-theme="dark"] .topic-title,
        [data-theme="dark"] .summary-date,
        [data-theme="dark"] .timeline-day,
        [data-theme="dark"] .timeline-source,
        [data-theme="dark"] .timeline-title,
        [data-theme="dark"] .timeline-desc,
        [data-theme="dark"] .today,
        [data-theme="dark"] .yesterday,
        [data-theme="dark"] .latest-update,
        [data-theme="dark"] .day-summary,
        [data-theme="dark"] .topic-header,
        [data-theme="dark"] .brief-summary,
        [data-theme="dark"] .reload-timer-label,
        [data-theme="dark"] .reload-timer,
        [data-theme="dark"] .modal-title,
        [data-theme="dark"] .submit-button,
        [data-theme="dark"] .cancel-button {
            color: #ffffff;
        }
        /* More comprehensive dark mode shadow removal */
        [data-theme="dark"] .brief-card,
        [data-theme="dark"] .brief-card:hover,
        [data-theme="dark"] .fab-button,
        [data-theme="dark"] .fab-button:hover,
        [data-theme="dark"] .timeline-container,
        [data-theme="dark"] .modal-content,
        [data-theme="dark"] .modal-button,
        [data-theme="dark"] .cta-button,
        [data-theme="dark"] .cta-button:hover,
        [data-theme="dark"] nav a,
        [data-theme="dark"] nav a.active,
        [data-theme="dark"] .article-item {
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
        }
        
        /* Global shadow removal for dark mode */
        [data-theme="dark"] * {
            box-shadow: none !important;
            -webkit-box-shadow: none !important;
            -moz-box-shadow: none !important;
        }
        
        .article-url-summary {
            font-size: 13px;
            color: var(--text-color);
            opacity: 0.7;
            font-style: italic;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .topic-count-display {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.7;
            margin-left: 10px;
            font-style: italic;
            padding-right: 5px;
            white-space: nowrap;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 2px solid var(--accent-color);
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        [data-theme="dark"] .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--accent-color);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .submit-button-container {
            display: flex;
            align-items: center;
        }
        
        .delete-button {
            position: absolute;
            bottom: 15px;
            right: 15px;
            color: #ff3b30;
            opacity: 0.6;
            font-size: 13px;
            background: transparent;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .delete-button:hover {
            opacity: 0.9;
            background-color: rgba(255, 59, 48, 0.1);
        }
        
        [data-theme="dark"] .delete-button {
            color: #ff6b6b;
        }
        
        .flash-messages {
            margin-bottom: 20px;
            width: 100%;
        }
        
        .flash-message {
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .flash-error {
            background-color: #fee2e2;
            color: #b91c1c;
            border: 1px solid #fecaca;
        }
        
        .flash-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .flash-info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .access-request-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 30px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        
        .access-request-form h2 {
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .access-request-form p {
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .philosophy-page {
            padding: 30px;
        }
        
        .philosophy-page .section-title {
            font-size: 32px;
            font-weight: 300;
            margin-bottom: 30px;
            color: var(--text-color);
        }
        
        .philosophy-section {
            margin-bottom: 40px;
        }
        
        .philosophy-section h2 {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .philosophy-section p {
            font-size: 16px;
            line-height: 1.7;
            margin-bottom: 15px;
            max-width: 700px;
            color: var(--text-color);
            opacity: 0.9;
        }
        
        [data-theme="dark"] .philosophy-section p {
            opacity: 0.85;
        }
        
        .notification-bell {
            margin-left: 8px;
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        
        .notification-bell:hover {
            opacity: 0.9;
        }
        
        [data-theme="dark"] .notification-bell {
            color: var(--text-color);
            opacity: 0.4;
        }
        
        [data-theme="dark"] .notification-bell:hover {
            opacity: 0.8;
        }
        
        .notification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10;
            justify-content: center;
            align-items: center;
        }
        
        .notification-modal-content {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 400px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
        }
        
        .notification-modal-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .notification-topic {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .notification-options {
            margin: 20px 0;
        }
        
        .notification-option {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .notification-option input {
            margin-right: 10px;
        }
        
        .notification-option label {
            color: var(--text-color);
        }
        
        /* Page Loading Overlay */
        .page-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        
        [data-theme="dark"] .page-loading-overlay {
            background-color: rgba(25, 25, 25, 0.8);
        }
        
        .page-loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            animation: spin 1s linear infinite;
        }
        
        [data-theme="dark"] .page-loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
        }
        
        /* Reddit Source Badge */
        .reddit-badge {
            display: inline-flex;
            align-items: center;
            background-color: #FF4500;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        [data-theme="dark"] .reddit-badge {
            background-color: #FF4500;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">loop: track all moves in a single timeline.</div>
        <nav>
            <a href="/" class="{% if active_tab == 'search' %}active{% endif %}">home</a>
            <a href="/history" class="{% if active_tab == 'history' %}active{% endif %}">briefs</a>
            <a href="/raison-detre" class="{% if active_tab == 'raison-detre' %}active{% endif %}">raison d'être</a>
        </nav>
        <div class="user-info">
            {% if user.is_authenticated %}
                <div class="user-avatar">
                    {% if user.profile_pic %}
                        <img src="{{ user.profile_pic }}" alt="{{ user.name }}" width="30" height="30">
                    {% else %}
                        <i class="fas fa-user"></i>
                    {% endif %}
                </div>
                <span>{{ user.name }}</span>
                <a href="{{ url_for('auth.logout') }}">logout</a>
            {% else %}
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span>not logged in</span>
                <a href="{{ url_for('auth.login') }}">login</a>
            {% endif %}
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <div class="main-container">
        <main class="brief-list">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <div class="flash-messages">
                        {% for category, message in messages %}
                            <div class="flash-message flash-{{ category }}">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            {% endwith %}
            
            {% if error %}
                <div class="error">
                    {{ error }}
                </div>
            {% endif %}
            
            {% if active_tab == 'search' %}
                <!-- Search form removed from here -->
                
                {% if history_entries %}
                    <h2 style="margin: 20px 0 20px 0;">your briefs 
                        <span class="topic-count-display">{{ history_entries|length }} out of 3 briefs used</span>
                    </h2>
                    {% if history_entries|length > 0 %}
                        <p class="latest-update">last updated {{ history_entries[0].timestamp|format_datetime('%b %d, %Y') }}</p>
                    {% endif %}
                    {% for entry in history_entries %}
                        <div class="brief-card" onclick="window.location.href='/history/{{ entry.query }}'">
                            <div class="home-card-header">
                                <div class="brief-title">
                                    {{ entry.query }}
                                    <i class="fas fa-bell notification-bell" onclick="event.stopPropagation(); openNotificationModal('{{ entry.query }}')"></i>
                                </div>
                                <div class="card-right-elements">
                                    <div class="detail-link">
                                        detailed analysis <span class="arrow">→</span>
                                    </div>
                                    <div class="refresh-info">
                                        <span class="reload-timer-label">auto-refresh in:</span>
                                        <span class="reload-timer" data-query="{{ entry.query }}">--:--</span>
                                    </div>
                                </div>
                            </div>
                            
                            {% set has_summary = false %}
                            
                            {# First priority: Show Today's summary if available #}
                            {% for key, entry_data in history.items() %}
                                {% if entry_data.query == entry.query and entry_data.day_summaries and 'Today' in entry_data.day_summaries and is_valid_summary(entry_data.day_summaries['Today']) and not has_summary %}
                                    <div class="brief-summary-container">
                                        <div class="summary-date today">Today <span class="live-dot"></span></div>
                                        <p class="brief-summary">{{ entry_data.day_summaries['Today'] }}</p>
                                    </div>
                                    {% set has_summary = true %}
                                {% endif %}
                            {% endfor %}
                            
                            {# Second priority: Show Yesterday's summary if available #}
                            {% if not has_summary %}
                                {% for key, entry_data in history.items() %}
                                    {% if entry_data.query == entry.query and entry_data.day_summaries and 'Yesterday' in entry_data.day_summaries and is_valid_summary(entry_data.day_summaries['Yesterday']) and not has_summary %}
                                        <div class="brief-summary-container">
                                            <div class="summary-date yesterday">Yesterday</div>
                                            <p class="brief-summary">{{ entry_data.day_summaries['Yesterday'] }}</p>
                                        </div>
                                        {% set has_summary = true %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                            
                            {# Last resort: fallback text - NOW REMOVED #}
                            {% if not has_summary %}
                                {# Fallback text removed - now using the arrow in top-right instead #}
                            {% endif %}
                            
                            <button class="delete-button" onclick="event.stopPropagation(); deleteHistoryItem('{{ entry.query }}')">
                                delete
                            </button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% elif active_tab == 'history' %}
                {% if query %}
                    <div class="brief-card expanded detail-page">
                        <div class="brief-title">{{ query }}</div>
                        <div class="brief-meta">
                            <!-- Removed timestamp from here -->
                            <div class="refresh-info">
                                <span class="reload-timer-label">auto-refresh in:</span>
                                <span class="reload-timer" data-query="{{ query }}">--:--</span>
                            </div>
                        </div>
                        
                        {% if topic_groups and topic_groups|length > 0 and topic_groups[0].day_summary %}
                            <p class="brief-summary">{{ topic_groups[0].day_summary }}</p>
                        {% endif %}
                        
                        {% if results %}
                            <div class="timeline-container">
                                {% set ns = namespace(current_day=None, current_day_summary=None) %}
                                
                                {% if topic_groups | length == 0 %}
                                    <div style="text-align: center; padding: 30px; color: #666;">
                                        <p>no news articles found for this query.</p>
                                    </div>
                                {% endif %}
                                
                                {% for topic in topic_groups %}
                                    {% set day = topic.day_group %}
                                    
                                    {% if day != ns.current_day %}
                                        {% set ns.current_day = day %}
                                        {% set ns.current_day_summary = topic.day_summary %}
                                        <div class="timeline-day">
                                            {{ day }}
                                            {% if day == "Today" %}
                                                <span class="live-dot"></span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if topic.day_summary %}
                                            <div class="day-summary">
                                                {{ topic.day_summary }}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                    
                                    <div class="timeline-item">
                                        <div class="topic-header" onclick="toggleTopic(this)">
                                            <span class="expand-icon"></span>
                                            <div class="topic-title">{{ topic.title }}</div>
                                            {% if topic.count > 1 %}
                                                <span class="topic-count">{{ topic.count }} articles</span>
                                            {% endif %}
                                            <div class="topic-time">{{ topic.newest_age }}</div>
                                        </div>
                                        
                                        <div class="topic-content">
                                            {% for article in topic.articles %}
                                                <div class="article-item">
                                                    <div class="timeline-source">{{ article.get('meta_url', {}).get('netloc', 'unknown source') }}</div>
                                                    {% if loop.index > 1 %}
                                                        <div class="timeline-title">{{ article.get('title', 'no title') }}</div>
                                                    {% endif %}
                                                    <div class="timeline-desc">{{ article.get('description', 'no description available') }}</div>
                                                    <div class="article-url-summary">{{ article.get('title', 'no title').split(' - ')[0] if ' - ' in article.get('title', 'no title') else article.get('title', 'no title').split('|')[0] if '|' in article.get('title', 'no title') else article.get('title', 'no title') }}</div>
                                                    <a href="{{ article.get('url', '#') }}" class="timeline-link" target="_blank">{{ article.get('url', 'no url available') }}</a>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="cta-button" onclick="window.location.href='/'" style="background-color: #6b7280;">
                            <i class="fas fa-arrow-left"></i> back to briefs
                        </button>
                        <button class="cta-button" onclick="forceRefresh('{{ query }}')">
                            <i class="fas fa-sync-alt"></i> refresh now
                        </button>
                        <button class="cta-button" onclick="deleteHistoryItem('{{ query }}')">
                            <i class="fas fa-trash"></i> delete this brief
                        </button>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 50px; color: #666;">
                        <h2>no briefs yet</h2>
                        <p style="margin: 20px 0;">add a search term to start tracking news topics</p>
                        <button class="cta-button" onclick="window.location.href='/'">
                            <i class="fas fa-plus"></i> add new brief
                        </button>
                    </div>
                {% endif %}
            {% elif active_tab == 'raison-detre' %}
                <div class="brief-card expanded philosophy-page">
                    
                    
                    <div class="philosophy-section">
                        <h2>why i built this</h2>
                        <p>
                            my vision for a sharper informational edge. in an era where information abundance creates 
                            its own form of scarcity—attention—the need for systems that value sequential, contextual, 
                            and verifiable information has never been more critical.
                        </p>
                        <p>
                            traditional news suffers from a fundamental reductionism—breaking complex narratives into
                            disconnected fragments that destroy context and coherence. skewed distribution adds to the problem–we see what a select few want us to see.
                        </p>
                    </div>
                    
                    <div class="philosophy-section">
                        <h2>beyond the headline</h2>
                        <p>
                            loop challenges this paradigm by restoring these connections, presenting not isolated data points
                            but complete trajectories—a temporal map of events and their relationships across multiple
                            dimensions of relevance. loop tracks trends, entities, and relationships across time–notifying you of immediate changes. your briefs are your own personal news feed–unrestricted by the constraints of publishers, advertisers, or the biases of the media.
                        </p>
                        <p>
                            my coarse take on antireductionism as a 17-year old <a href="https://docs.google.com/document/d/1GXAdOSCwvc_XALn1WTwRVDOdDcFC1lfeAx1WLTpyg9w/" target="_blank" style="font-weight: bold; text-decoration: underline;">here</a>.
                        </p>
                    </div>
                    
                    <div class="philosophy-section">
                        <h2>intelligence as a service</h2>
                        <p>
                            the information landscape now operates with its own mens rea—a system designed to capture attention
                            without the ethical framework to ensure integrity. it's a subtle crime of modern media: presenting
                            partial truths as complete pictures. loop serves as a corrective measure, applying computational rigor to restore missing context.
                        </p>
                        <p>
                            information lives across the news, social media, and the internet. add a brief and see it stitched together in real-time.
                        </p>
                    </div>
                    
                    <!-- Removed "first principles approach" section -->
                    
                    <!-- Removed "personal mission" section -->
                    
                    <div style="margin-top: 40px; text-align: center; color: #777; font-style: italic; padding: 20px;">
                        <p>"The ability to reduce everything to simple fundamental laws does not imply the ability to start from those laws and reconstruct the universe."</p>
                        <p style="font-size: 0.9em; margin-top: 8px;">— P.W. Anderson</p>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
    
    <!-- Floating action button for adding new briefs - only shown to logged in users with fewer than 3 topics -->
    {% if user.is_authenticated and history_entries|length < 3 %}
    <div class="fab-button" onclick="openNewBriefModal()">
        <i class="fas fa-plus"></i>
    </div>
    {% endif %}
    
    <!-- Modal for adding new briefs -->
    <div id="newBriefModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">add new brief</h2>
            {% if user.is_authenticated %}
                {% if history_entries|length >= 3 %}
                    <p style="margin-bottom: 20px; color: #ff3b30;">You've reached the maximum of 3 briefs. Please remove one before adding another.</p>
                    <div class="modal-buttons">
                        <button type="button" class="modal-button cancel-button" onclick="closeNewBriefModal()">close</button>
                    </div>
                {% else %}
                    <form method="post" action="/" id="modalSearchForm">
                        <input type="text" name="query" placeholder="add a topic" class="search-box" required>
                        <div class="search-options" style="display: none;">
                            <select name="count" class="option-select">
                                <option value="10">10 results</option>
                                <option value="20">20 results</option>
                                <option value="30">30 results</option>
                                <option value="50" selected>50 results</option>
                            </select>
                            <select name="freshness" class="option-select">
                                <option value="pd">past day</option>
                                <option value="pw">past week</option>
                                <option value="pm">past month</option>
                                <option value="py" selected>past year</option>
                            </select>
                            <select name="similarity_threshold" class="option-select">
                                <option value="0.2">low similarity</option>
                                <option value="0.3">medium similarity</option>
                                <option value="0.4" selected>high similarity</option>
                            </select>
                            <input type="hidden" name="force_refresh" value="false">
                        </div>
                        <div class="modal-buttons">
                            <button type="button" class="modal-button cancel-button" onclick="closeNewBriefModal()">cancel</button>
                            <div class="submit-button-container">
                                <button type="submit" class="modal-button submit-button" id="submitBriefButton">add brief</button>
                                <div class="loading-spinner" id="briefLoadingSpinner"></div>
                            </div>
                        </div>
                    </form>
                {% endif %}
            {% else %}
                <p style="margin-bottom: 20px;">You need to <a href="{{ url_for('auth.login') }}" style="color: var(--accent-color);">login</a> to add briefs.</p>
                <div class="modal-buttons">
                    <button type="button" class="modal-button cancel-button" onclick="closeNewBriefModal()">close</button>
                    <a href="{{ url_for('auth.login') }}" class="modal-button submit-button" style="display: inline-block; text-align: center; text-decoration: none;">login</a>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Modal for requesting access - no longer needed but kept for structure -->
    <div id="requestAccessModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">google login available</h2>
            <p>You can now log in directly with your Google account. No access request needed.</p>
            <div class="modal-buttons">
                <button type="button" class="modal-button cancel-button" onclick="closeRequestAccessModal()">close</button>
                <a href="{{ url_for('auth.login') }}" class="modal-button submit-button" style="display: inline-block; text-align: center; text-decoration: none;">login now</a>
            </div>
        </div>
    </div>
    
    <!-- Modal for notification settings -->
    <div id="notificationModal" class="notification-modal">
        <div class="notification-modal-content">
            <h2 class="notification-modal-title">notification settings</h2>
            <p>set update frequency for <span id="notificationTopic" class="notification-topic"></span></p>
            
            <div class="notification-options">
                <div class="notification-option">
                    <input type="radio" id="notifyHourly" name="notifyFrequency" value="hourly">
                    <label for="notifyHourly">hourly updates</label>
                </div>
                <div class="notification-option">
                    <input type="radio" id="notifyDaily" name="notifyFrequency" value="daily" checked>
                    <label for="notifyDaily">daily summary</label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="modal-button cancel-button" onclick="closeNotificationModal()">cancel</button>
                <button type="button" class="modal-button submit-button" onclick="saveNotificationSettings()">save settings</button>
            </div>
        </div>
    </div>
    
    <script>
        function toggleTopic(element) {
            const content = element.nextElementSibling;
            const isExpanded = element.classList.contains('expanded');
            
            // Toggle expanded class
            if (isExpanded) {
                element.classList.remove('expanded');
                content.style.display = 'none';
            } else {
                element.classList.add('expanded');
                content.style.display = 'block';
            }
        }
        
        function deleteHistoryItem(query) {
            if (confirm('are you sure you want to delete this brief?')) {
                fetch('/api/delete_history/' + encodeURIComponent(query), {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/history';
                    }
                });
            }
        }
        
        function clearHistory() {
            if (confirm('are you sure you want to clear all briefs?')) {
                fetch('/api/clear_history', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/';
                    }
                });
            }
        }
        
        function openNewBriefModal() {
            document.getElementById('newBriefModal').style.display = 'flex';
        }
        
        function closeNewBriefModal() {
            document.getElementById('newBriefModal').style.display = 'none';
        }
        
        function openRequestAccessModal() {
            document.getElementById('requestAccessModal').style.display = 'flex';
        }
        
        function closeRequestAccessModal() {
            document.getElementById('requestAccessModal').style.display = 'none';
        }
        
        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        
        function saveNotificationSettings() {
            const topic = document.getElementById('notificationTopic').textContent;
            const frequency = document.querySelector('input[name="notifyFrequency"]:checked').value;
            
            // Save preference to localStorage
            localStorage.setItem(`notify_${topic}`, frequency);
            
            // Send to server
            fetch('/api/notifications/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    topic: topic,
                    frequency: frequency
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Saved notification preference for "${topic}": ${frequency}`);
                } else {
                    console.error('Failed to save notification settings');
                }
            })
            .catch(error => {
                console.error('Error saving notification settings:', error);
            });
            
            // Close the modal
            closeNotificationModal();
            
            // Prevent navigation to the details page
            event.stopPropagation();
        }

        let reloadTimer;
        let currentSeconds = 3600; // 60 minutes default
        let currentQuery = ""; // Store current query for timer management
        let timerIntervals = {}; // Store intervals for each query
        
        // Initialize functions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Get the current query from the page
            const queryElements = document.querySelectorAll('.brief-title');
            for (let element of queryElements) {
                if (window.location.pathname.includes('/history/')) {
                    currentQuery = element.textContent.trim();
                    break;
                }
            }
            
            // Dark mode toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = themeToggle.querySelector('i');
            
            // Check for saved theme preference or use device preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
            }
            
            // Toggle theme when button is clicked
            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'dark') {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                    themeIcon.className = 'fas fa-moon';
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    themeIcon.className = 'fas fa-sun';
                }
            });
            
            // Initialize all timers on page
            const timerElements = document.getElementsByClassName('reload-timer');
            if (timerElements.length > 0) {
                // If we're on a specific history page, just handle that one
                if (currentQuery) {
                    initializeTimer(currentQuery);
                    timerIntervals[currentQuery] = setInterval(() => updateReloadTimer(currentQuery), 1000);
                } else {
                    // Otherwise initialize timers for all briefs on the home page
                    for (let element of timerElements) {
                        const query = element.getAttribute('data-query');
                        if (query) {
                            initializeTimer(query);
                            timerIntervals[query] = setInterval(() => updateReloadTimer(query), 1000);
                        }
                    }
                }
            }
            
            // Close modal if clicked outside
            window.onclick = function(event) {
                const briefModal = document.getElementById('newBriefModal');
                const accessModal = document.getElementById('requestAccessModal');
                const notificationModal = document.getElementById('notificationModal');
                
                if (event.target == briefModal) {
                    closeNewBriefModal();
                }
                if (event.target == accessModal) {
                    closeRequestAccessModal();
                }
                if (event.target == notificationModal) {
                    closeNotificationModal();
                }
            }
            
            // Show loading spinner when form is submitted
            const searchForm = document.getElementById('modalSearchForm');
            const submitButton = document.getElementById('submitBriefButton');
            const loadingSpinner = document.getElementById('briefLoadingSpinner');
            const cancelButton = document.querySelector('.cancel-button');
            
            if (searchForm) {
                searchForm.addEventListener('submit', function(e) {
                    // Show spinner
                    loadingSpinner.style.display = 'block';
                    
                    // Disable buttons
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.7';
                    submitButton.textContent = 'adding...';
                    
                    cancelButton.disabled = true;
                    cancelButton.style.opacity = '0.7';
                    
                    // Add a console log to verify this code is running
                    console.log('Form submitted, showing spinner and disabling buttons');
                    
                    // Let the form submission proceed
                    return true;
                });
            }
            
            // Show loading spinner when access request form is submitted
            const accessForm = document.getElementById('requestAccessForm');
            const accessButton = document.getElementById('submitAccessButton');
            const accessSpinner = document.getElementById('accessLoadingSpinner');
            
            if (accessForm) {
                accessForm.addEventListener('submit', function() {
                    // Show spinner
                    accessSpinner.style.display = 'block';
                    
                    // Disable buttons
                    accessButton.disabled = true;
                    accessButton.style.opacity = '0.7';
                    accessButton.textContent = 'submitting...';
                    
                    const accessCancelButton = accessForm.querySelector('.cancel-button');
                    accessCancelButton.disabled = true;
                    accessCancelButton.style.opacity = '0.7';
                });
            }
        });
        
        function initTimerForElement(element, query) {
            const timerStartKey = `timerStart_${query}`;
            const cycleStartKey = `cycleStart_${query}`;
            
            // Check if we have a stored cycle start time for this query
            let cycleStartTime = localStorage.getItem(cycleStartKey);
            let currentSecs = 3600;
            
            if (cycleStartTime) {
                // We have an existing cycle - use it
                const now = new Date().getTime();
                cycleStartTime = parseInt(cycleStartTime, 10);
                
                // Calculate elapsed seconds since the start of this cycle
                const elapsedSeconds = Math.floor((now - cycleStartTime) / 1000);
                
                // Calculate remaining seconds until next 60-minute mark (3600 seconds)
                currentSecs = Math.max(0, 3600 - elapsedSeconds);
            }
            
            // Update the element with the current time
            const minutes = Math.floor(currentSecs / 60);
            const seconds = currentSecs % 60;
            element.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function initializeTimer(query) {
            if (!query) return;
            
            // Use query-specific keys for localStorage
            const timerStartKey = `timerStart_${query}`;
            const cycleStartKey = `cycleStart_${query}`;
            const refreshDueKey = `refreshDue_${query}`;
            
            // Check if we have a stored cycle start time for this query
            let cycleStartTime = localStorage.getItem(cycleStartKey);
            let refreshDueTime = localStorage.getItem(refreshDueKey);
            
            const now = new Date().getTime();
            
            // If no refresh due time exists or it's invalid, create a new one
            if (!refreshDueTime || isNaN(parseInt(refreshDueTime, 10))) {
                // Set refresh due time to 60 minutes from now
                refreshDueTime = now + (3600 * 1000); // 60 minutes in milliseconds
                localStorage.setItem(refreshDueKey, refreshDueTime.toString());
                console.log(`Setting new refresh due time for ${query}: ${new Date(refreshDueTime).toLocaleTimeString()}`);
            } else {
                // Parse the existing refresh due time
                refreshDueTime = parseInt(refreshDueTime, 10);
                
                // If the refresh is already due, trigger it now
                if (now >= refreshDueTime) {
                    console.log(`Refresh already due for ${query}, triggering now`);
                    // Clear timer data before refresh
                    localStorage.removeItem(cycleStartKey);
                    localStorage.removeItem(refreshDueKey);
                    // Perform refresh
                    forceRefresh(query);
                    return;
                }
                console.log(`Refresh due for ${query} at: ${new Date(refreshDueTime).toLocaleTimeString()}`);
            }
            
            // If we don't have cycle start time, initialize it
            if (!cycleStartTime) {
                localStorage.setItem(cycleStartKey, now.toString());
            }
            
            // Also update the original search time if this is the first time
            if (!localStorage.getItem(timerStartKey)) {
                localStorage.setItem(timerStartKey, now.toString());
            }
            
            // Calculate and set the remaining seconds
            const remainingMilliseconds = refreshDueTime - now;
            const remainingSeconds = Math.max(0, Math.floor(remainingMilliseconds / 1000));
            
            if (!window.timerSeconds) {
                window.timerSeconds = {};
            }
            window.timerSeconds[query] = remainingSeconds;
            
            // Update the display immediately
            updateReloadTimer(query);
        }
        
        function startNewCycle(query) {
            // Start a fresh 60-minute cycle
            const now = new Date().getTime();
            const refreshDueTime = now + (3600 * 1000); // 60 minutes in milliseconds
            
            if (!window.timerSeconds) {
                window.timerSeconds = {};
            }
            window.timerSeconds[query] = 3600; // 60 minutes in seconds
            
            // Record when this cycle started and when it's due
            localStorage.setItem(`cycleStart_${query}`, now.toString());
            localStorage.setItem(`refreshDue_${query}`, refreshDueTime.toString());
            
            // Also update the original search time if this is the first time
            if (!localStorage.getItem(`timerStart_${query}`)) {
                localStorage.setItem(`timerStart_${query}`, now.toString());
            }
            
            console.log(`Starting new 60-minute refresh cycle for ${query}, due at: ${new Date(refreshDueTime).toLocaleTimeString()}`);
        }

        function updateReloadTimer(query) {
            if (!query) return;
            
            if (!window.timerSeconds) {
                window.timerSeconds = {};
            }
            
            // Initialize if not already set
            if (window.timerSeconds[query] === undefined) {
                initializeTimer(query);
                return;
            }
            
            // Instead of just decrementing, recalculate based on actual time
            const refreshDueKey = `refreshDue_${query}`;
            const refreshDueTime = parseInt(localStorage.getItem(refreshDueKey), 10);
            const now = new Date().getTime();
            
            // If we have a valid refresh due time
            if (refreshDueTime && !isNaN(refreshDueTime)) {
                // Calculate actual remaining seconds
                const remainingMilliseconds = refreshDueTime - now;
                const remainingSeconds = Math.max(0, Math.floor(remainingMilliseconds / 1000));
                window.timerSeconds[query] = remainingSeconds;
                
                // If time is up and we should refresh
                if (remainingSeconds <= 0) {
                    if (timerIntervals[query]) {
                        clearInterval(timerIntervals[query]);
                        delete timerIntervals[query];
                    }
                    
                    // Clear the cycle info before reloading
                    localStorage.removeItem(`cycleStart_${query}`);
                    localStorage.removeItem(`refreshDue_${query}`);
                    
                    // Use the same forceRefresh function for consistency
                    forceRefresh(query);
                    return;
                }
            } else {
                // If no due time exists, start a new cycle
                startNewCycle(query);
                return;
            }
            
            const minutes = Math.floor(window.timerSeconds[query] / 60);
            const seconds = window.timerSeconds[query] % 60;
            const timerString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const timerElements = document.querySelectorAll(`.reload-timer[data-query="${query}"]`);
            for (let element of timerElements) {
                element.textContent = timerString;
            }
        }

        function forceRefresh(query) {
            // Add force_refresh parameter to URL and reload
            const url = new URL(window.location.href);
            url.searchParams.set('force_refresh', 'true');
            
            // If a specific query is provided, force refresh that query
            if (query) {
                // If we're on home page, add query parameter
                if (window.location.pathname === '/' || window.location.pathname === '') {
                    url.searchParams.set('query', query);
                }
                
                // If we're on the detail page for this query, force refresh it
                if (window.location.pathname.includes(`/history/${query}`)) {
                    // Just reload the page with force_refresh=true
                    window.location.href = url.toString();
                    return;
                }
            }
            
            // Always do a full page reload
            window.location.href = url.toString();
        }
        
        function openNotificationModal(topic) {
            const modal = document.getElementById('notificationModal');
            const topicElement = document.getElementById('notificationTopic');
            
            // Set the topic in the modal
            topicElement.textContent = topic;
            
            // Check if we have saved preferences for this topic
            const savedPrefs = localStorage.getItem(`notify_${topic}`);
            if (savedPrefs) {
                const frequency = savedPrefs;
                document.querySelector(`input[name="notifyFrequency"][value="${frequency}"]`).checked = true;
            } else {
                // Default to daily
                document.querySelector('input[name="notifyFrequency"][value="daily"]').checked = true;
            }
            
            // Show the modal
            modal.style.display = 'flex';
        }
        
        // Page loading indicator - improved implementation
        function showLoadingOverlay() {
            document.getElementById('pageLoadingOverlay').style.display = 'flex';
        }
        
        // Capture all link clicks
        document.addEventListener('click', function(e) {
            // Check if the click is on a link
            const linkElement = e.target.closest('a');
            
            if (linkElement && !e.ctrlKey && !e.metaKey && !linkElement.target && 
                linkElement.hostname === window.location.hostname) {
                // Only for internal links not opening in new tabs
                e.preventDefault(); // Prevent default navigation
                showLoadingOverlay(); // Show overlay immediately
                
                // Brief delay to ensure overlay appears, then navigate
                setTimeout(function() {
                    window.location.href = linkElement.href;
                }, 50);
            }
        });
        
        // Capture form submissions
        document.addEventListener('submit', function(e) {
            const form = e.target;
            
            // Only handle forms that navigate (not AJAX forms)
            if (!form.hasAttribute('data-ajax')) {
                showLoadingOverlay();
            }
        });
        
        // Show overlay on page unload
        window.addEventListener('beforeunload', function() {
            showLoadingOverlay();
        });
        
        // Add Reddit badges to articles from Reddit
        document.addEventListener('DOMContentLoaded', function() {
            const articleItems = document.querySelectorAll('.article-item');
            
            articleItems.forEach(function(article) {
                // Check if this is from Reddit (stored as data attribute)
                if (article.getAttribute('data-reddit') === 'true') {
                    // Find the source element
                    const sourceEl = article.querySelector('.article-source');
                    if (sourceEl) {
                        // Add Reddit badge
                        const badge = document.createElement('span');
                        badge.className = 'reddit-badge';
                        badge.textContent = 'Reddit';
                        sourceEl.appendChild(badge);
                    }
                }
            });
        });
    </script>
    
    <!-- Page loading overlay -->
    <div id="pageLoadingOverlay" class="page-loading-overlay" style="display: none;">
        <div class="page-loading-spinner"></div>
    </div>
</body>
</html> 